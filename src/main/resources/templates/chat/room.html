<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="https://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>

<div layout:fragment="content">
  <div class="row">
    <div class="col-md-12">
      <table id="conversation" class="table table-striped">
        <thead>
        <tr>
          <th>채팅방</th>
        </tr>
        </thead>
        <tbody id="messages">
        </tbody>
      </table>
    </div>
    <div class="col-md-6">
      <form class="form-inline">
        <div class="form-group">
          <input type="text" id="sender" class="form-control" placeholder="name...">
          <input type="text" id="content" class="form-control" placeholder="content...">
        </div>
        <button id="send" class="btn btn-default" type="submit">Send</button>
      </form>
    </div>
  </div>
</div>

<script th:inline="javascript" layout:fragment="script">
  const inputContent = document.getElementById("content");

  const host = window.location.hostname; // 현재 호스트 이름 가져오기
  const port = window.location.port; // 포트 설정
  const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws'; // HTTPS일 경우 'wss', 아니면 'ws'
  // const brokerURL = `${protocol}://${host}:${port}/ws-stomp`;
  const stompClient = new StompJs.Client({
    brokerURL: `${protocol}://${host}:${port}/ws-stomp`
  });

  const roomId = [[${roomId}]];
  stompClient.onConnect = (frame) => {
    // setConnected(true);
    console.log('Connected: '+frame);
    stompClient.subscribe('/room/'+roomId, (chatMessage) => {
      console.log(chatMessage)
      let rContent = JSON.parse(chatMessage.body).message;
      if(rContent != null)
        showMessageContent(JSON.parse(chatMessage.body).message)
      // showMessageContent(JSON.parse(messageContent.body).content)
    });
  };

  stompClient.onWebSocketError = (error) => {
    alert('웹소켓에러' + error);
  }

  stompClient.onStompError = (frame) => {
    console.error('Broker reported error: ' + frame.headers['message']);
    console.error('Additional details: ' + frame.body);
  };


  function connect() {
    stompClient.activate();
  }

  function disconnect() {
    stompClient.deactivate();
    setConnected(false);
    console.log("Disconnected");
  }

  function sendMessageContent() {
    stompClient.publish({
      destination: "/send/"+roomId,
      body: JSON.stringify({ 'sender': $("#sender").val(), 'content': $("#content").val() })
    });
    inputContent.value = '';
  }

  function showMessageContent(message) {
    $("#messages").append("<tr><td>" + message + "</td></tr>");
  }

  $(function () {
    $("form").on('submit', (e) => e.preventDefault());
    $( "#connect" ).click(() => connect());
    $( "#disconnect" ).click(() => disconnect());
    $( "#send" ).click(() => sendMessageContent());
  });

  connect();
</script>
</body>
</html>