<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layout.html}">
<div layout:fragment="content" class="container mt-4">
    <!-- 상단 검색/정렬 영역 -->
    <div class="mb-3">
        이 영역은 위에 검색이나 정렬, 필요한 기능들이 들어갈 예정입니다.
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#friendSearchModal">친구 찾기</button>
    </div>

    <!-- 친구 찾기 모달 -->
    <div class="modal fade" id="friendSearchModal" tabindex="-1" aria-labelledby="friendSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="friendSearchModalLabel">친구 찾기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 친구 검색 기능 -->
                    <div class="container mt-3">
                        <!-- 입력 필드 -->
                        <div class="mb-3">
                            <label for="searchId" class="form-label">아이디 검색</label>
                            <input type="text" id="searchId" class="form-control" placeholder="아이디를 입력하세요" onkeyup="searchUserById()">
                        </div>
                        <!-- 친구 검색 결과 -->
                        <div id="suggestions"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 친구 목록 테이블 -->
    <div>
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>#</th>
                <th>아이디</th>
                <th>채팅</th>
                <th>삭제</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="userId, status : ${friendList}">
                <td th:text="${status.index + 1}"></td>
                <td th:text="${userId}"></td>
                <td><a href="#" class="btn btn-primary">채팅</a></td>
                <td><button class="btn btn-danger">삭제</button></td>
            </tr>
            </tbody>
        </table>
    </div>

    <script th:inline="javascript">
        let debounceTimer;
        let lastSearchId = '';

        function searchUserById() {
            const searchId = document.getElementById('searchId').value;

            // 입력값이 비어있으면 검색 결과를 지우고 리턴
            if (searchId.length === 0) {
                document.getElementById('suggestions').innerHTML = '';
                return;
            }

            // 동일한 검색어에 대해 새로운 요청을 보내지 않도록
            if (lastSearchId === searchId) {
                return;
            }

            lastSearchId = searchId; // 최신 검색어로 갱신

            clearTimeout(debounceTimer); // 이전 요청을 취소
            debounceTimer = setTimeout(() => {
                fetch(`/friend/searchUserById?searchId=${searchId}`)
                    .then(response => response.json())
                    .then(data => {
                        let suggestionsHtml = `
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>아이디</th>
                            <th>신청</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                        if (data.length === 0) {
                            suggestionsHtml += '<tr><td colspan="2">검색된 유저가 없습니다.</td></tr>';
                        } else {
                            data.forEach(user => {
                                suggestionsHtml += `
                            <tr>
                                <td>${user.userId}</td>
                                <td>
                                    <button class="btn ${user.isFriend === 1 ? 'btn-secondary' :
                                                    (user.sent === 1 ? 'btn-warning' :
                                                        (user.received === 1 ? 'btn-success' : 'btn-primary'))}"
                                            onclick="${user.isFriend === 1 ? '' :
                                                    (user.sent === 1 ? `cancelRequest('${user.userId}')` :
                                                        (user.received === 1 ? `acceptRequest('${user.userId}')` : `sendRequest('${user.userId}')`))}">
                                        ${user.isFriend === 1 ? '이미 친구입니다' :
                                                    (user.sent === 1 ? '친구 신청 취소' :
                                                        (user.received === 1 ? '친구 신청 수락' : '신청'))}
                                    </button>
                                </td>
                            </tr>
                        `;
                            });
                        }
                        suggestionsHtml += '</tbody></table>';
                        document.getElementById('suggestions').innerHTML = suggestionsHtml;
                    })
                    .catch(error => console.error('Error:', error));
            }, 300);
        }

        function sendRequest(userId) {
            let flag = confirm(userId + '에게 친구 신청을 보내시겠습니까?');
            if(flag){
                fetch('/friend/sendRequest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'  // 서버가 JSON을 받을 수 있도록 설정
                    },
                    body: JSON.stringify({ friendId: userId })  // 요청 본문에 friendId를 JSON 형태로 담아 보냄
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('친구 신청이 성공적으로 보내졌습니다!');
                            // 모달 새로 고침 등 추가적인 동작이 필요하면 여기에 작성
                        } else {
                            alert('친구 신청 실패');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }


    </script>
</div>
